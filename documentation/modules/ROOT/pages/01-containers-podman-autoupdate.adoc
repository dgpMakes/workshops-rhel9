[#podmanautoupdate]
=== Podman auto-update

In this section we are going to see how to automatically update the container image we have just deployed.

We need to manage the lifecycle application for the container image, so we will need to update the image according our needs.

When deploying multiple devices, for instance in Edge deployments, updating the containers is a challenge. Using **podman auto-update** we can automatically update them with only update the container image in the registry.

=== How we will implement the automatic updates

We will implement the automatic updates in the following way:

image::serverless/podman-autoupdate.png[]

1. A systemd timer will be used to periodically look for new versions for the container image in the registry.
2. If a new image is found in the registry podman will download it.
3. The running container image will be updated.

=== Creating the systemd timer

Using the **core** user create the timer:

[source,bash,subs="+macros,+attributes"]
[core@rhel9 ~]$ cat << EOF .config/systemd/user/podman-auto-update.timer 
[Unit]
Description=Podman auto-update timer
[Timer]
# This example runs the podman auto-update daily within a two-hour
# randomized window to reduce system load
#OnCalendar=daily
#Persistent=true
#RandomizedDelaySec=7200
# activate every minute
OnBootSec=30
OnUnitActiveSec=30
[Install]
WantedBy=timers.target
EOF
[core@rhel9 ~]$

Now we will create the unit that will be executed by the above timer:

[source,bash,subs="+macros,+attributes"]
[core@rhel9 ~]$ cat << EOF .config/systemd/user/podman-auto-update.service
[Unit]
Description=Podman auto-update service
Documentation=man:podman-auto-update(1)
[Service]
ExecStart=/usr/bin/podman auto-update
[Install]
WantedBy=multi-user.target default.target
EOF
[core@rhel9 ~]$

TIP: We can create an script to perform some more tasks if needed and configure the script within **[Service]** section in **ExecStart**.

=== Configuring the registry auto-update

Now we have to check the registries that are configured in the system, so as the root user:

[source,bash,subs="+macros,+attributes"]
[root@rhel9 ~]# cat /etc/containers/registries.conf
[registries.search]
registries = ['quay.io', 'registry.access.redhat.com', 'registry.redhat.io', 'docker.io']
[registries.insecure]
registries = ['']
[registries.block]
registries = []
[root@rhel9 ~]# 

Add the registry you will use to upload your container image to the **[registries.search]** section if it is not present.

Now as the **core** user we will need to modify the systemd unit which starts the container, we will need to add the following to de **podman run** command:

[source]
--label io.containers.autoupdate=registry

This label tells podman auto-update which containers images can update. As this label is set to **registry** podman auto-update will inspect the images' registry to look for a new image.

TIP: You can read the man page for **podman-auto-update** to get more information.

So the unit will be:

[source,bash,subs="+macros,+attributes"]
[core@rhel9 ~]$ cat .config/systemd/user/container-httpd.service
# container-f0716002b0458d1720fe6d16264b13c101fa61b11315694c9d016b839ec139a5.service
# autogenerated by Podman 4.0.2
# Thu Jun 16 12:50:04 CEST 2022
[Unit]
Description=Podman container-f0716002b0458d1720fe6d16264b13c101fa61b11315694c9d016b839ec139a5.service
Documentation=man:podman-generate-systemd(1)
Wants=network-online.target
After=network-online.target
RequiresMountsFor=%t/containers
[Service]
Environment=PODMAN_SYSTEMD_UNIT=%n
Restart=on-failure
TimeoutStopSec=70
ExecStartPre=/bin/rm -f %t/%n.ctr-id
ExecStart=/usr/bin/podman run --cidfile=%t/%n.ctr-id --cgroups=no-conmon --rm --sdnotify=conmon --replace -d -p 8080:8081 --label io.containers.autoupdate=registry --name demoday quay.io/rhte_2019/2048-demoday:latest
ExecStop=/usr/bin/podman stop --ignore --cidfile=%t/%n.ctr-id
ExecStopPost=/usr/bin/podman rm -f --ignore --cidfile=%t/%n.ctr-id
Type=notify
NotifyAccess=all
[Install]
WantedBy=default.target
[core@rhel9 ~]$

=== Lets update the application

Create a new Dockerfile as the **workshop** user:

[source,bash,subs="+macros,+attributes"]
[workshop@rhel9 Dockerfiles]$ cat << EOF Dockerfile.2048.rhel9.v2
# buildah build -f Dockerfile.2048.rhel9.v2 -t 2048-demoday:v2
# podman run --rm -d -p 8080:8081 localhost/2048-demoday:v2
FROM registry.redhat.io/rhel9/nginx-120
MAINTAINER Jose Angel de Bustos <abustosp@redhat.com> 
COPY 2048 /opt/app-root/src
COPY index.html /opt/app-root/src/2048
COPY demoday.png /opt/app-root/src/2048/banner.png
COPY nginx.conf /etc/nginx/nginx.conf
EXPOSE 8081
ENTRYPOINT ["nginx", "-g", "daemon off;"]
EOF
[workshop@rhel9 Dockerfiles]$

Now look for an png image (~ 917x509 pixels) and store it using **demoday.png** as filename and create the image:

[source,bash,subs="+macros,+attributes"]
[workshop@rhel9 Dockerfiles]$ buildah build -f Dockerfile.2048.rhel9.v1 -t 2048-demoday:v2
...
[workshop@rhel9 Dockerfiles]$ podman images
REPOSITORY                          TAG         IMAGE ID      CREATED       SIZE
localhost/2048-demoday              v2          618f3cb61744  1 second ago  382 MB
localhost/2048-demoday              v1          d48137cd5225  5 hours ago   382 MB
quay.io/rhte_2019/2048-demoday      latest      d48137cd5225  5 hours ago   382 MB
registry.redhat.io/rhel9/nginx-120  latest      8b24fbc725c8  6 weeks ago   379 MB
[workshop@rhel9 Dockerfiles]$

Tag the new image as the **latest** and upload it to the registry. Maybe you will need to perform a login in the registry:

[source,bash,subs="+macros,+attributes"]
[workshop@rhel9 Dockerfiles]$ podman tag localhost/2048-demoday:v2 quay.io/rhte_2019/2048-demoday:latest
[workshop@rhel9 Dockerfiles]$ podman images
REPOSITORY                          TAG         IMAGE ID      CREATED        SIZE
localhost/2048-demoday              v2          618f3cb61744  2 minutes ago  382 MB
quay.io/rhte_2019/2048-demoday      latest      618f3cb61744  2 minutes ago  382 MB
localhost/2048-demoday              v1          d48137cd5225  5 hours ago    382 MB
registry.redhat.io/rhel9/nginx-120  latest      8b24fbc725c8  6 weeks ago    379 MB
[workshop@rhel9 Dockerfiles]$ podman push quay.io/rhte_2019/2048-demoday:latest
...
[workshop@rhel9 Dockerfiles]$

To update the container image the container must be running. As we have deployed a serverless application maybe the container is not running.

First we are going to check the container images that are present for the **core** user and if there is some container running:

[source,bash,subs="+macros,+attributes"]
[core@rhel9 ~]$ podman images
REPOSITORY                      TAG         IMAGE ID      CREATED      SIZE
quay.io/rhte_2019/2048-demoday  latest      d48137cd5225  6 hours ago  382 MB
[core@rhel9 ~]$ podman ps --all
CONTAINER ID  IMAGE       COMMAND     CREATED     STATUS      PORTS       NAMES
[core@rhel9 ~]$